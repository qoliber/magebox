# MageBox Test Container - Fedora 42
# Used for integration testing without Docker-in-Docker
# Set MAGEBOX_TEST_MODE=1 to skip Docker operations

FROM fedora:42

LABEL maintainer="qoliber"
LABEL description="MageBox integration test environment for Fedora 42"

# Install dependencies
RUN dnf install -y \
    dnf-plugins-core \
    curl \
    git \
    nginx \
    openssl \
    which \
    procps-ng \
    && dnf clean all

# Enable Remi repository for PHP
RUN dnf install -y https://rpms.remirepo.net/fedora/remi-release-42.rpm \
    && dnf config-manager setopt remi.enabled=1 \
    && dnf clean all

# Install PHP versions (8.1, 8.2, 8.3, 8.4) with Magento-required extensions + Xdebug
RUN dnf install -y \
    unzip \
    php81-php-fpm php81-php-cli php81-php-common php81-php-opcache php81-php-sodium php81-php-zip php81-php-curl php81-php-mbstring php81-php-xml php81-php-pecl-xdebug3 \
    php81-php-bcmath php81-php-gd php81-php-intl php81-php-mysqlnd php81-php-soap \
    php82-php-fpm php82-php-cli php82-php-common php82-php-opcache php82-php-sodium php82-php-zip php82-php-curl php82-php-mbstring php82-php-xml php82-php-pecl-xdebug3 \
    php82-php-bcmath php82-php-gd php82-php-intl php82-php-mysqlnd php82-php-soap \
    php83-php-fpm php83-php-cli php83-php-common php83-php-opcache php83-php-sodium php83-php-zip php83-php-curl php83-php-mbstring php83-php-xml php83-php-pecl-xdebug3 \
    php83-php-bcmath php83-php-gd php83-php-intl php83-php-mysqlnd php83-php-soap \
    php84-php-fpm php84-php-cli php84-php-common php84-php-opcache php84-php-sodium php84-php-zip php84-php-curl php84-php-mbstring php84-php-xml php84-php-pecl-xdebug3 \
    php84-php-bcmath php84-php-gd php84-php-intl php84-php-mysqlnd php84-php-soap \
    && dnf clean all

# Install Go for building MageBox
RUN dnf install -y golang \
    && dnf clean all

# Install mkcert for SSL testing
RUN curl -L -o /usr/local/bin/mkcert https://github.com/FiloSottile/mkcert/releases/download/v1.4.4/mkcert-v1.4.4-linux-amd64 \
    && chmod +x /usr/local/bin/mkcert

# Create test user (non-root)
RUN useradd -m -s /bin/bash testuser \
    && mkdir -p /home/testuser/.magebox \
    && chown -R testuser:testuser /home/testuser

# Create nginx config directory writable by testuser
RUN mkdir -p /home/testuser/.magebox/nginx \
    && chown -R testuser:testuser /home/testuser/.magebox

# Set up MageBox directories
RUN mkdir -p /tmp/magebox \
    && chmod 777 /tmp/magebox

# Copy MageBox source
WORKDIR /app
COPY . .

# Build MageBox
RUN go build -o /usr/local/bin/magebox ./cmd/magebox

# Create php symlink (Remi PHP doesn't provide 'php' command, only php81/php82/etc.)
RUN ln -s /usr/bin/php82 /usr/local/bin/php

# Install Composer
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# Copy Composer auth.json if it exists (for Magento repo access)
# This file should contain repo.magento.com credentials
RUN mkdir -p /root/.config/composer
COPY test/containers/test.auth.json* /root/.config/composer/
RUN if [ -f /root/.config/composer/test.auth.json ]; then \
        mv /root/.config/composer/test.auth.json /root/.config/composer/auth.json; \
    fi

# Copy Blackfire credentials if it exists (for Blackfire testing)
COPY test/containers/test.blackfire.env* /tmp/
RUN if [ -f /tmp/test.blackfire.env ]; then \
        mkdir -p /root/.magebox; \
        mv /tmp/test.blackfire.env /root/.magebox/blackfire.env; \
    fi

# Set environment variables for test mode
ENV MAGEBOX_TEST_MODE=1
ENV HOME=/root

# Run as root for full testing capability
WORKDIR /root

# Create a sample project for testing
RUN mkdir -p /root/test-project/app/etc \
    && mkdir -p /root/test-project/pub

# Default command runs tests
CMD ["magebox", "--version"]
